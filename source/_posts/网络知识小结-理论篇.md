---
title: 网络知识小结-理论篇
tags: 网络知识
categories: 技术分享
---
##### 如今互联网时代，差不多每人都有一个终端能够浏览网上的信息。那这些终端是怎么连接到网上并浏览信息的呢？要想了解这些知识，就要从网络的基础知识开始说起。

#### 起源
##### &nbsp;&nbsp;&nbsp;&nbsp;互联网的起源可以追溯到1960年代美国联邦政府委托进行的一项研究，目的是创建容错与电脑网络的通信。互联网的前身ARPANET最初在1980年代作为区域学术和军事网络连接的骨干。
##### &nbsp;&nbsp;&nbsp;&nbsp;1974年，罗伯特·卡恩和文顿·瑟夫提出TCP/IP，定义在电脑网络之间传送报文的方法。1986年，美国国家科学基金会创建超级电脑中心与学术机构之间互联基于TCP/IP技术的骨干网络NSFNET，速度由最初的56kbit/s，接着为T1（1.5Mbit/s），最后发展至T3（45Mbit/s）。商业互联网服务提供商（ISP）出现于1980年代末和1990年代初。ARPANET于1990年退役。

#### 网络基础
##### &nbsp;&nbsp;&nbsp;&nbsp;网络通信的实现，分了好几层，每一层都有自己特有的功能，而且每一层都靠下一层的支持。用户接触到，只是最上面的一层，称为应用层。如果要深入理解互联网，必须从最下层开始，自下而上理解每一层的功能。

##### 网络分层模型有三种：

>> 网络分层
>>> OSI七层  
>>> 理论五层  
>>> TCP/IP 四层模型
--------------------

##### 分层模型概览：

> ### OSI七层
>> 应用层  
>> 表示层  
>> 回话层  
>> 传输层  
>> 网络层  
>> 数据链路层  
>> 物理层

> 理论五层
>> 应用层  
>> 传输层  
>> 网络层  
>> 数据链路层  
>> 物理层  

> TCP/IP 四层模型
>> 应用层  
>> 传输层  
>> 网际层  
>> 网络接口层

![网络分层图](https://s3.ax1x.com/2020/12/27/r5s32n.png)


### **基于理论五层**

各层的作用如下：

- 应用层(Application Layer)
   - 直接为用户的应用进程提供服务
   - 常见的协议有 HTTP、HTTPS、SMTP、TELNET等
- 传输层(Transport Layer)
   - 传输层任务是为应用层进行通信的两个进程之间提供一个可靠的 **端到端** 服务，使它们看不到传输层以下的数据通信的细节。
   - **端到端** 的意思是数据来自某个**端口**，再传送给指定的**端口**
   - **端口**：一个0到65535间的整数，用来指定特定应用程序
   - 常见的协议有TCP、UDP等
- 网络层
  - 网络层的任务是选择合适的路由，使分组能够准确的按照地址找到目的地，并给交付目的地的传输层。
  - 网络层协议为IP协议
- 数据链路层
  - 数据链路层是将数据组合为一个个的**帧**，确定电信号的数据包格式。
  - 数据链路层的协议为**以太网**协议
- 物理层
  - 物理层定义了把电脑之间连接起来所用设备的标准，在网络中的网络信号都是通过**0和1**的电信号进行传输的。
 

越下面的层，越靠近硬件；越上面的层，越靠近用户。

### 理论解读

#### 物理层
- 数字信号通过编码器转化为电信号
- 电信号通过滤波器、模拟信号转换器译码成数字信号

#### 数据链路层
- 以太网协议即指导文档规范
  - 规定一组电信号构成一个数据包，叫做**帧(frame)**，每一帧分为两部分：标头（Head）和数据（Data）。
  - 标头长度固定，18个字节（1Byte=8bit），数据最短46字节，最长1500字节，因此总数据包最短就是64字节，最长就是1518字节。
  - 标头就是数据包的一些说明项，比如：发送者MAC地址，接收者MAC地址，数据类型等；数据就是发送的具体内容。
  - 由于链路层存在MTU（最大传输单元 Maximum transmission unit）的限制，如果网络层的报文超过MTU，那就必须进行分片。

- 网卡地址（MAC)
  - mac地址全世界独一无二，长度是48个二进制位，通常用12个十六进制数表示。

- 广播
  - 一块网卡怎么会知道另一块网卡的MAC地址，**ARP协议，地址解析协议（Address Resolution Protocol）**
    - 用于根据给定**网络层地址**，IPv4或IPv6，查找其对应的**数据链路层地址**，例如MAC地址；这里用到了**ARP 高速缓存**，在同一局域网内，通过ARP高速缓存，找与IP地址对应的MAC地址。
    -  ARP 协议是局域网内部的协议。如果局域网中找不到对应的MAC地址，就把数据包传送到两个子网连接处的网关，让网关去处理。
  - 有了接收方MAC地址，怎么发送过去
    - 向本局域网内的所有计算机发广播，让接收到广播的每台计算机自己去判断，是否为接收方。
    - 如果局域网内计算机太多，如果每台都在发报文、接报文，那会引起广播风暴。那如果避免这种情况的出现，就需要引入一套新的地址。这就导致了网络层的出现，网络层定义出网络地址，网络地址能够区分不同的计算机是否属于同一个**子网络**。

#### 网络层

- 网络地址的制定标准是**IP协议**
  - 通过IP协议定义出来的地址是IP地址，现有标准是IPV4和IPV6。
  - 通过IP地址，如何判断两台计算机是否属于同一个子网络？这就需要子网掩码。两个IP地址与子网掩码进行**按位与**运算，结果相同则在同一子网，否则不在。
  - IP数据包，根据IP协议发送的数据。也分为**标头**和**数据**两个部分，其中标头长度是20-60字节（IPV6固定为40字节），整个数据包的总长度最大为65535（2^16）字节，数据包就是 65535 -（20~60）（IPV6是固定的40）。
  - 源IP地址，目的IP地址，8未TTL，time to live，生存时间等。

#### 传输层

- 传输的数据包到底给谁用？**传输层**
  - 传输层的功能，就是建立**端口到端口**的通信。相比于传输层，网络层则是建立**主机到主机**的通信。只要确定主机和端口，就能实现程序之间的交流。Unix系统把主机和端口，叫做**套接字（socket）**。

- UDP
  - UDP协议：用户数据报协议。数据报传输需要加入端口信息，UDP协议就由此产生。
    - UDP协议比较简单，容易实现，但缺点是可靠性较差，一旦数据包发出，无法知道对方是否收到。不检查数据包是否到达、网络是否拥塞等情况。
    - 格式几乎就是在数据前面加上端口号。
    - 16位源端口号+16位目的端口号+16位UDP长度+16位UDP校验+数据（可有可无），这样UDP的标头，固定是8字节（64位）。![UDP数据包](https://s3.ax1x.com/2021/01/06/sVtLUP.png)
    - 再加上IP包之后，整个以太网数据包就是：![以太网数据包](https://s3.ax1x.com/2021/01/06/sVU6Fx.png)
  - UDP中一个包的大小最大能有多大
    - 局域网环境下，建议将UDP数据控制在1472字节以下。为什么是**1472字节**？以太网的数据帧长度必须在46-1500字节之间，这是以太网的物理特性决定的，这个1500字节是链路层的MTU（最大传输单元）。这个MTU是链路层的数据区，不包含链路层的首部和尾部的18个字节（发送者MAC地址+接收者MAC地址+数据类型，各6个字节），因为以太网协议帧最长是1518字节。而网络层IP数据报有最小20字节的限制，所以IP数据包的数据区长度最大是1480字节。而这1480字节就是存放TCP报文或UDP数据报的。因为UDP数据报的首部8字节，所以UDP数据报的数据区最大长度为1472字节。基于数据尽量不分片的原则，建议UDP的数据控制在1472字节以下为好。
    - Internet编程时，建议将UDP数据控制在548字节以下。ipv4协议规定ip层的最小重组缓冲区大小为576字节。由于UDP的标头是8字节，IP包的标头是20-60字节，所以UDP的数据长度控制在**548字节（576-8-20）**以内。
- TCP协议：传输控制协议
  - 由于UDP协议的不可靠性，TCP协议就此诞生，与UDP不同的是TCP的确认机制，每发出一个数据包都要求确认。如果有一个数据包遗失，就收不到确认，发出方就知道有必要重发这个数据包了。
  - TCP还提供**拥塞控制**用于缓解**网络拥堵**。
  - TCP协议能够确保数据不会遗失。它的缺点是过程复杂、实现困难、消耗较多的资源。![TCP数据格式](https://s3.ax1x.com/2021/02/20/y4hyUs.png)
  - TCP标头在20-60字节之间，除了源端口号和目的端口号之外，还包含了序号、确认号等各种信息，用于保证可靠连接与数据重发。
  - TCP数据包也是内嵌在IP数据包的数据部分，TCP数据包没有长度限制，理论上可以无限长，但为了不分割，通常TCP数据包的长度不超过IP数据包的长度。![y4hTa9.png](https://s3.ax1x.com/2021/02/20/y4hTa9.png)
  - 发送数据拼装过程![拼装过程](https://s3.ax1x.com/2021/02/20/y44VsS.png)

###### TCP为什么可靠
- 确认应答机制
  - TCP中将每个字节的数据都进行了编号，就是同步序列号（SYN）
- 超时重传机制
  - 有了序列号之后，为了准确送达数据，就有了超时重传。在发送端数据发出后，一定时间没有接收到确认，发送端就会重传数据。没有接收确认的原因，有可能是数据丢失，还有可能是网络拥堵，如果是网络拥堵，重传的数据，对于接收端是重复数据，这时接收端就需要根据序列号进行去重。
- 流量控制
  - 接收处理数据的速度是一定的，如果发送端发送数据的速度太快，就有可能把接收端的缓存打满，如果接收端不进行流量控制，就会导致数据丢包的现象。TCP支持根据接收端的处理能力，来决定发送端的发送速度，这个机制就叫流量控制。
  - TCP的首部有控制窗口大小的字段，里面存放着窗口大小信息。
  - 接收端会根据缓冲区大小，灵活调整流量窗口大小
  - 如果接收端缓冲区满了,发送端不再发送数据，发送端需要定期发送一个试探窗口，目的是为了接收端的缓冲区有空间时及时告诉给发送端。
- 拥塞窗口
  - 拥塞控制是防止过多的数据注入到网络中，防止网络中的路由器或链路过载，是一个全局性的过程
  - 拥塞控制机制
    - 慢开始
    - 拥塞控制
    - 快重传
    - 快恢复

#### 应用层

- 规定应用程序的数据格式，例如：Email、WWW、FTP、HTTP(s)等
- 直接面对用户
- 应用数据直接放TCP或UDP数据包的数据部分![y44QGq.png](https://s3.ax1x.com/2021/02/20/y44QGq.png)


### Wireshark 实践

##### UDP数据包分析

- Wireshark 抓UDP包![UDP数据包](https://s3.ax1x.com/2021/02/20/y4LTOI.png)
- 从抓包数据可以看出UDP协议数据是封装了要传输的数据和UDP标头数据![UDP数据详情](https://s3.ax1x.com/2021/02/20/y4LxpQ.png)
- IP协议数据包![IP协议](https://s3.ax1x.com/2021/02/20/y4Ogjs.png)
- 以太网协议数据包![以太网数据包](https://s3.ax1x.com/2021/02/20/y4Ogjs.png)

##### TCP数据包分析

###### **TCP 三次握手**
- TCP三次握手 ![三次握手](https://s3.ax1x.com/2021/02/20/y4XLRg.png)
- TCP第一次握手![第一次握手](https://s3.ax1x.com/2021/02/20/y4jlWD.png)
- TCP第二次握手![第二次握手](https://s3.ax1x.com/2021/02/20/y4jhfU.png)
- TCP第三次握手![第三次握手](https://s3.ax1x.com/2021/02/20/y4v3NV.png)
- TCP数据![TCP数据](https://s3.ax1x.com/2021/02/20/y4vau9.png)

###### **TCP 四次挥手**

- 客户端向服务端发送关闭请求
- 服务端接受到请求向客户端发送待关闭通知
- 服务端发送结束请求，并进入LAST_ACK状态，等待来自客户端的最后一个ACK。
- 客户端收到服务端的已关闭信息之后发送一个确认包，并进入TIME_WAIT状态。





### 参考
- https://mp.weixin.qq.com/s/4WT7gnXxNk2C_iMRCgA_jA
- https://juejin.im/post/6876860213991833613?utm_source=gold_browser_extension
- https://juejin.im/entry/6844903666445451272
- https://www.cnblogs.com/steven520213/p/8005258.html
- http://www.9upk.com/article/2537.html
- https://mp.weixin.qq.com/s/4WT7gnXxNk2C_iMRCgA_jA
- https://blog.csdn.net/wojiaopanpan/article/details/69944970
- https://mp.weixin.qq.com/s/9llz-yGUbYgP2kmcwwkJdA
- https://hit-alibaba.github.io/interview/basic/network/TCP.html
- https://github.com/facebookarchive/SocketRocket
- https://github.com/pkyeck/socket.IO-objc
- https://github.com/robbiehanson/CocoaAsyncSocket
- https://github.com/socketio/socket.io
- https://github.com/CoderJackyHuang/iOS-Socket-C-Version
- https://juejin.cn/post/6844903958624878606
- https://blog.csdn.net/guoyuqi0554/article/details/17678459

#### Written By 多点-移动运营研发部-任冰
